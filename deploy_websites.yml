- hosts: Production_Host
  vars:
    http_port: 80
    user: "{{ ansible_user_id }}"
    packages:
      - git
      - apache2
      - git-lfs

  vars_files:
    - conf/websites.yml

  roles:
    - { role: capotej.packagecloud, repository: github/git-lfs, os: ubuntu, version: xenial, become: yes }
  tasks:
    - name: Install packages 
      apt: 
        name: "{{ packages }}"
        update_cache: yes
        state: latest
      become: yes
    
    - name: Run git-lfs install command
      shell: git lfs install

    - name: Change Owner:Group of '/var/www' to www-data:www-data and set permissions to 0755
      file:
        path: /var/www
        owner: www-data
        group: www-data
        mode: 0775
        recurse: yes
      become: yes
    
    - name: Add {{ user }} to www-data group in order to give it write access to '/var/www' without having to run the next command as become (sudo)
      user:
        name: "{{ user }}"
        groups: www-data
        append: yes
      become: yes

    - name: Get updated files from git repository 
      git:
        repo: git@github.com:mezka/{{ item.repo }}
        dest: /var/www/{{ item.domain }}
        accept_hostkey: yes
        update: no
      become: no
      loop: "{{ websites }}"

    - name: Enable mod_rewrite Apache2 module
      apache2_module:
        name: rewrite
        state: present
      become: yes
      notify:
        - restart apache2

    - name: Change apache2 listen on port {{ http_port }}
      lineinfile: dest=/etc/apache2/ports.conf line="Listen {{ http_port }}" regexp="^Listen " state=present
      become: yes
      notify:
        - restart apache2

    - name: apache2 virtualhost on port {{ http_port }}
      lineinfile: dest=/etc/apache2/sites-available/000-default.conf line="<VirtualHost *:{{ http_port }}>" regexp="^<VirtualHost \*:"
      become: yes
      notify:
        - restart apache2
  
    - include_tasks: create_virtual_host.yml
      vars: 
        domain: "{{ item.domain }}"
        repo: "{{ item.repo }}"
      loop: "{{ websites }}" 
    
    - name: a2ensite everything 
      command: a2ensite {{ item.domain }}
      args:
        creates: /etc/apache2/sites-enabled/{{ item.domain }}.conf
      become: yes
      notify:
        - restart apache2
      loop: "{{ websites }}"

  handlers:
    - name: restart apache2
      service:
        name: apache2
        state: restarted
      become: yes
